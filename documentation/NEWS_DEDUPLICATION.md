# æ–°é—»å»é‡åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸ºäº†è§£å†³ç§‘åˆ›æ¿è‚¡ç¥¨æ–°é—»çš„é‡å¤é—®é¢˜ï¼Œç³»ç»Ÿå·²é›†æˆåŸºäº **all-MiniLM-L6-v2** åµŒå…¥æ¨¡å‹çš„æ–°é—»å»é‡åŠŸèƒ½ã€‚å½“å¤šä¸ªç§‘åˆ›æ¿è‚¡ç¥¨æ”¶åˆ°ç›¸åŒæˆ–ç›¸ä¼¼çš„æ–°é—»æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶å»é™¤é‡å¤çš„æ–°é—»æ¡ç›®ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½ç›¸ä¼¼åº¦æ£€æµ‹
- **åµŒå…¥æ¨¡å‹**: ä½¿ç”¨ `sentence-transformers/all-MiniLM-L6-v2` æ¨¡å‹
- **ç›¸ä¼¼åº¦ç®—æ³•**: ä½™å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)
- **ç›¸ä¼¼åº¦é˜ˆå€¼**: 0.85ï¼ˆå¯é…ç½®ï¼‰
- **å»é‡å­—æ®µ**: é»˜è®¤é’ˆå¯¹æ–°é—»æ ‡é¢˜ (title)ï¼Œä¹Ÿæ”¯æŒæ‘˜è¦ (summary) æˆ–å†…å®¹ (content)

### 2. å»é‡ç­–ç•¥
- **ä¿ç•™åŸåˆ™**: é‡åˆ°é‡å¤æ—¶ï¼Œä¿ç•™ç¬¬ä¸€æ¡æ–°é—»ï¼Œç§»é™¤åç»­ç›¸ä¼¼çš„æ–°é—»
- **åˆ†ç»„å»é‡**: æŒ‰è‚¡ç¥¨ä»£ç  (symbol) åˆ†ç»„ï¼Œé¿å…è¯¯åˆ ä¸åŒè‚¡ç¥¨çš„ç›¸å…³æ–°é—»
- **ç§‘åˆ›æ¿ä¸“ç”¨**: ä»…å¯¹ç§‘åˆ›æ¿è‚¡ç¥¨ï¼ˆä»£ç ä»¥ SH688 å¼€å¤´ï¼‰çš„æ–°é—»è¿›è¡Œå»é‡
- **éä¾µå…¥å¼**: å»é‡å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºåŸå§‹é€»è¾‘ï¼Œä¸å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

### 3. é›†æˆä½ç½®
å»é‡åŠŸèƒ½å·²é›†æˆåˆ°ä»¥ä¸‹å…³é”®ä½ç½®ï¼š

#### (1) å®æ—¶æ–°é—»è·å–
åœ¨ `search_stock_news()` å‡½æ•°ä¸­ï¼Œä» AKShare è·å–å®æ—¶æ–°é—»åç«‹å³å»é‡ï¼š

```python
# agent_engine/agent/agent.py - å®æ—¶æ–°é—»å»é‡
if realtime_results:
    realtime_results = deduplicate_news_by_embedding(
        realtime_results,
        similarity_threshold=0.85,
        field_to_compare='title'
    )
```

#### (2) CSV æ–‡ä»¶åˆå¹¶
åœ¨å°†æ–°é—»ä¿å­˜åˆ° `data_flow/news.csv` æ—¶ï¼Œå¯¹åˆå¹¶åçš„å…¨éƒ¨æ•°æ®æŒ‰è‚¡ç¥¨åˆ†ç»„å»é‡ï¼š

```python
# agent_engine/agent/agent.py - CSVåˆå¹¶åå»é‡
for symbol_code, group in combined.groupby('symbol'):
    if str(symbol_code).startswith('SH688'):
        deduplicated_list = deduplicate_news_by_embedding(
            group_list,
            similarity_threshold=0.85,
            field_to_compare='title'
        )
```

## ä½¿ç”¨æ–¹æ³•

### å®‰è£…ä¾èµ–
é¦–å…ˆå®‰è£… sentence-transformers åº“ï¼š

```bash
pip install sentence-transformers
```

æˆ–è€…ä½¿ç”¨é¡¹ç›®çš„ requirements.txtï¼š

```bash
pip install -r requirements.txt
```

### ç‹¬ç«‹ä½¿ç”¨å»é‡å·¥å…·
ä¹Ÿå¯ä»¥åœ¨å…¶ä»–è„šæœ¬ä¸­ç‹¬ç«‹ä½¿ç”¨å»é‡å·¥å…·ï¼š

```python
from utils.news_deduplicator import deduplicate_news_by_embedding

# ç¤ºä¾‹ï¼šå¯¹æ–°é—»åˆ—è¡¨å»é‡
news_list = [
    {"title": "ç§‘åˆ›æ¿å¹³å‡è‚¡ä»·39.44å…ƒï¼Œ8è‚¡è‚¡ä»·è¶…300å…ƒ", "symbol": "SH688008"},
    {"title": "ç§‘åˆ›æ¿å¹³å‡è‚¡ä»·39.44å…ƒ 8è‚¡è‚¡ä»·è¶…300å…ƒ", "symbol": "SH688111"},  # ç›¸ä¼¼
    # ... æ›´å¤šæ–°é—»
]

deduplicated = deduplicate_news_by_embedding(
    news_list,
    similarity_threshold=0.85,  # ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰
    field_to_compare='title'     # æ¯”è¾ƒå­—æ®µ
)
```

### DataFrame æ ¼å¼å»é‡
å¯¹ pandas DataFrame æ ¼å¼çš„æ–°é—»æ•°æ®å»é‡ï¼š

```python
from utils.news_deduplicator import deduplicate_news_dataframe
import pandas as pd

df = pd.read_csv('data_flow/news.csv')
df_deduplicated = deduplicate_news_dataframe(
    df,
    similarity_threshold=0.85,
    field_to_compare='title'
)
```

## é…ç½®å‚æ•°

### similarity_threshold (ç›¸ä¼¼åº¦é˜ˆå€¼)
- **ç±»å‹**: float
- **èŒƒå›´**: 0.0 - 1.0
- **é»˜è®¤å€¼**: 0.85
- **è¯´æ˜**: 
  - å€¼è¶Šé«˜ï¼Œå»é‡è¶Šä¸¥æ ¼ï¼ˆåªç§»é™¤éå¸¸ç›¸ä¼¼çš„æ–°é—»ï¼‰
  - å€¼è¶Šä½ï¼Œå»é‡è¶Šå®½æ¾ï¼ˆå¯èƒ½è¯¯åˆ ä¸åŒçš„æ–°é—»ï¼‰
  - æ¨èå€¼: 0.80 - 0.90

### field_to_compare (æ¯”è¾ƒå­—æ®µ)
- **ç±»å‹**: str
- **å¯é€‰å€¼**: 'title', 'summary', 'content'
- **é»˜è®¤å€¼**: 'title'
- **è¯´æ˜**: 
  - `title`: é’ˆå¯¹æ–°é—»æ ‡é¢˜å»é‡ï¼ˆæ¨èï¼‰
  - `summary`: é’ˆå¯¹æ–°é—»æ‘˜è¦å»é‡
  - `content`: é’ˆå¯¹æ–°é—»å…¨æ–‡å»é‡ï¼ˆè®¡ç®—é‡å¤§ï¼‰

## å·¥ä½œåŸç†

### 1. æ–‡æœ¬åµŒå…¥
ä½¿ç”¨ all-MiniLM-L6-v2 æ¨¡å‹å°†æ–°é—»æ ‡é¢˜è½¬æ¢ä¸º 384 ç»´çš„å‘é‡è¡¨ç¤ºï¼š

```
"ç§‘åˆ›æ¿å¹³å‡è‚¡ä»·39.44å…ƒ" â†’ [0.123, -0.456, 0.789, ..., 0.234]  (384ç»´)
```

### 2. ç›¸ä¼¼åº¦è®¡ç®—
è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼š

```
similarity = cos(Î¸) = (A Â· B) / (||A|| Ã— ||B||)
```

- ç›¸ä¼¼åº¦ = 1.0: å®Œå…¨ç›¸åŒ
- ç›¸ä¼¼åº¦ = 0.85+: éå¸¸ç›¸ä¼¼ï¼ˆè§†ä¸ºé‡å¤ï¼‰
- ç›¸ä¼¼åº¦ < 0.85: ä¸åŒçš„æ–°é—»

### 3. å»é‡å†³ç­–
éå†æ‰€æœ‰æ–°é—»ï¼Œä¿ç•™ç¬¬ä¸€æ¡ï¼Œç§»é™¤ä¸å®ƒç›¸ä¼¼åº¦ â‰¥ 0.85 çš„åç»­æ–°é—»ï¼š

```
æ–°é—»1: "ç§‘åˆ›æ¿å¹³å‡è‚¡ä»·39.44å…ƒï¼Œ8è‚¡è‚¡ä»·è¶…300å…ƒ"  â†’ ä¿ç•™
æ–°é—»2: "ç§‘åˆ›æ¿å¹³å‡è‚¡ä»·39.44å…ƒ 8è‚¡è‚¡ä»·è¶…300å…ƒ"    â†’ ç§»é™¤ï¼ˆç›¸ä¼¼åº¦=0.92ï¼‰
æ–°é—»3: "æ·±æ²ªåŒ—ç™¾å…ƒè‚¡æ•°é‡è¾¾153åª"                â†’ ä¿ç•™ï¼ˆç›¸ä¼¼åº¦=0.35ï¼‰
```

## æ€§èƒ½è€ƒè™‘

### æ¨¡å‹åŠ è½½
- **é¦–æ¬¡åŠ è½½**: çº¦ 2-5 ç§’ï¼ˆä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼Œçº¦ 90MBï¼‰
- **åç»­ä½¿ç”¨**: æ¨¡å‹ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œè°ƒç”¨æ—¶æ— éœ€é‡æ–°åŠ è½½

### è®¡ç®—å¼€é”€
- **å°‘é‡æ–°é—»** (< 10æ¡): å‡ ä¹æ— æ„ŸçŸ¥å»¶è¿Ÿ (< 0.1ç§’)
- **ä¸­ç­‰æ•°é‡** (10-50æ¡): çº¦ 0.5-1 ç§’
- **å¤§é‡æ–°é—»** (> 100æ¡): çº¦ 2-5 ç§’

### ä¼˜åŒ–å»ºè®®
1. ä»…å¯¹ç§‘åˆ›æ¿æ–°é—»å»é‡ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
2. æŒ‰è‚¡ç¥¨åˆ†ç»„å»é‡ï¼Œå‡å°‘æ¯”è¾ƒæ¬¡æ•°
3. è®¾ç½®åˆç†çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œå¹³è¡¡å‡†ç¡®æ€§å’Œæ•ˆç‡

## æ—¥å¿—ç¤ºä¾‹

å¯ç”¨å»é‡åï¼Œç³»ç»Ÿä¼šè¾“å‡ºè¯¦ç»†çš„å»é‡æ—¥å¿—ï¼š

```
ğŸ” å¯¹ 5 æ¡å®æ—¶æ–°é—»è¿›è¡ŒåµŒå…¥å»é‡...
ğŸ”§ åŠ è½½å¥å­åµŒå…¥æ¨¡å‹: sentence-transformers/all-MiniLM-L6-v2
âœ… æ¨¡å‹åŠ è½½æˆåŠŸ
ğŸ” å¼€å§‹å¯¹ 5 æ¡æ–°é—»è¿›è¡ŒåµŒå…¥å»é‡ï¼ˆé˜ˆå€¼=0.85ï¼‰
âœ… å»é‡å®Œæˆ: åŸå§‹ 5 æ¡ â†’ ä¿ç•™ 3 æ¡ï¼ˆç§»é™¤ 2 æ¡é‡å¤ï¼‰
âœ… æˆåŠŸè·å– 3 æ¡å®æ—¶æ–°é—»ï¼ˆè‚¡ç¥¨ï¼šSH688008ï¼‰

ğŸ” å¯¹è‚¡ç¥¨ SH688008 çš„ 15 æ¡æ–°é—»è¿›è¡ŒåµŒå…¥å»é‡...
âœ… å»é‡å®Œæˆ: åŸå§‹ 15 æ¡ â†’ ä¿ç•™ 12 æ¡ï¼ˆç§»é™¤ 3 æ¡é‡å¤ï¼‰
ğŸ’¾ å·²å°†æ–°é—»è¿½åŠ åˆ° data/news.csvï¼ˆå»é‡åï¼‰
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ¨¡å—å¯¼å…¥å¤±è´¥
**é”™è¯¯ä¿¡æ¯**: `ModuleNotFoundError: No module named 'sentence_transformers'`

**è§£å†³æ–¹æ¡ˆ**:
```bash
pip install sentence-transformers
```

### é—®é¢˜2: æ¨¡å‹ä¸‹è½½ç¼“æ…¢
**åŸå› **: æ¨¡å‹æ–‡ä»¶æ‰˜ç®¡åœ¨ HuggingFaceï¼Œå›½å†…ä¸‹è½½å¯èƒ½è¾ƒæ…¢

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨é•œåƒæºï¼š
   ```bash
   export HF_ENDPOINT=https://hf-mirror.com
   ```
2. æˆ–æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ç¼“å­˜ï¼š
   ```bash
   mkdir -p ~/.cache/huggingface/hub
   # ä¸‹è½½æ¨¡å‹æ–‡ä»¶åˆ°è¯¥ç›®å½•
   ```

### é—®é¢˜3: å»é‡æ•ˆæœä¸ç†æƒ³
**è°ƒæ•´å‚æ•°**:
- è¯¯åˆ å¤ªå¤šç›¸ä¼¼æ–°é—»ï¼š**æé«˜**é˜ˆå€¼åˆ° 0.90 æˆ– 0.95
- æœªèƒ½è¯†åˆ«é‡å¤æ–°é—»ï¼š**é™ä½**é˜ˆå€¼åˆ° 0.80 æˆ– 0.75

### é—®é¢˜4: æ€§èƒ½å½±å“
**ä¼˜åŒ–ç­–ç•¥**:
1. ä»…å¯¹éœ€è¦å»é‡çš„è‚¡ç¥¨å¯ç”¨ï¼ˆç§‘åˆ›æ¿ï¼‰
2. é™åˆ¶å•æ¬¡å¤„ç†çš„æ–°é—»æ•°é‡
3. è€ƒè™‘å¼‚æ­¥å¤„ç†æˆ–åå°æ‰¹å¤„ç†

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰ç›¸ä¼¼åº¦è®¡ç®—
å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–åµŒå…¥æ¨¡å‹ï¼Œå¦‚ï¼š
- `paraphrase-multilingual-MiniLM-L12-v2`: å¤šè¯­è¨€æ”¯æŒæ›´å¥½
- `text2vec-base-chinese`: ä¸“ä¸ºä¸­æ–‡ä¼˜åŒ–
- `bge-small-zh-v1.5`: ç™¾åº¦å‡ºå“çš„ä¸­æ–‡æ¨¡å‹

### æ··åˆå»é‡ç­–ç•¥
ç»“åˆå¤šç§å»é‡æ–¹æ³•ï¼š
1. ç²¾ç¡®åŒ¹é…ï¼štitle å®Œå…¨ç›¸åŒ
2. åµŒå…¥ç›¸ä¼¼åº¦ï¼šè¯­ä¹‰ç›¸ä¼¼
3. ç¼–è¾‘è·ç¦»ï¼šå­—ç¬¦çº§ç›¸ä¼¼

## æ–‡ä»¶ç»“æ„

```
AStockArena/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ news_deduplicator.py       # å»é‡å·¥å…·æ¨¡å—
â”œâ”€â”€ agent_engine/
â”‚   â””â”€â”€ agent/
â”‚       â””â”€â”€ agent.py                # é›†æˆå»é‡é€»è¾‘
â”œâ”€â”€ requirements.txt                # ä¾èµ–åˆ—è¡¨ï¼ˆå·²æ·»åŠ  sentence-transformersï¼‰
â””â”€â”€ documentation/
    â””â”€â”€ NEWS_DEDUPLICATION.md       # æœ¬æ–‡æ¡£
```

## ç›¸å…³èµ„æº

- **sentence-transformers æ–‡æ¡£**: https://www.sbert.net/
- **all-MiniLM-L6-v2 æ¨¡å‹**: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2
- **ä½™å¼¦ç›¸ä¼¼åº¦**: https://en.wikipedia.org/wiki/Cosine_similarity

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-12-02)
- âœ… é›†æˆ all-MiniLM-L6-v2 åµŒå…¥æ¨¡å‹
- âœ… å®ç°åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„å»é‡ç®—æ³•
- âœ… æ”¯æŒé’ˆå¯¹æ ‡é¢˜ã€æ‘˜è¦æˆ–å†…å®¹å»é‡
- âœ… é›†æˆåˆ°å®æ—¶æ–°é—»è·å–æµç¨‹
- âœ… é›†æˆåˆ° CSV æ–‡ä»¶åˆå¹¶æµç¨‹
- âœ… æ·»åŠ ç§‘åˆ›æ¿ä¸“ç”¨è¿‡æ»¤
- âœ… æä¾›ç‹¬ç«‹æµ‹è¯•è„šæœ¬
- âœ… å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
